name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  check-releasable:
    name: Check for releasable changes
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      next_version: ${{ steps.version.outputs.next_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - name: Check for unreleased changes
        id: check
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "No previous tags found, this will be the first release"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            # Check if there are conventional commits since the last tag
            COMMITS_SINCE_TAG=$(git rev-list ${LATEST_TAG}..HEAD --count)

            if [ "$COMMITS_SINCE_TAG" -gt 0 ]; then
              echo "Found $COMMITS_SINCE_TAG commits since last tag"

              # Check if any of these commits are releasable (feat, fix, etc.)
              RELEASABLE=$(git log ${LATEST_TAG}..HEAD --oneline | grep -E '^[a-f0-9]+ (feat|fix|perf|refactor)(\(|:)' || true)

              if [ -n "$RELEASABLE" ]; then
                echo "Found releasable commits:"
                echo "$RELEASABLE"
                echo "has_changes=true" >> $GITHUB_OUTPUT
              else
                echo "No releasable commits found (only chores, docs, etc.)"
                echo "has_changes=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "No commits since last tag"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Calculate next version
        id: version
        if: steps.check.outputs.has_changes == 'true'
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

          # Remove 'v' prefix
          CURRENT_VERSION=${LATEST_TAG#v}

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Check for breaking changes
          if git log ${LATEST_TAG}..HEAD --format=%B | grep -q 'BREAKING CHANGE:'; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          # Check for features
          elif git log ${LATEST_TAG}..HEAD --oneline | grep -qE '^[a-f0-9]+ feat(\(|:)'; then
            MINOR=$((MINOR + 1))
            PATCH=0
          # Otherwise it's a patch (fix, perf, refactor)
          else
            PATCH=$((PATCH + 1))
          fi

          NEXT_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "Next version: $NEXT_VERSION"
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT

  build-macos:
    name: Build macOS
    needs: check-releasable
    if: needs.check-releasable.outputs.has_changes == 'true'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - name: Install dependencies
        run: |
          pnpm --dir app/frontend install
          cd app && npm install

      - name: Build Electron app
        run: |
          cd app
          npm run package
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Generate checksums
        run: |
          cd app/release

          # Generate consolidated checksums
          rm -f sha256.txt sha512.txt
          find . -type f \( -name "*.dmg" -o -name "*.zip" \) | while read -r file; do
            filename=$(basename "$file")
            shasum -a 256 "$file" | awk -v fname="$filename" '{print $1 "  " fname}' >> sha256.txt
            shasum -a 512 "$file" | awk -v fname="$filename" '{print $1 "  " fname}' >> sha512.txt
            echo "Generated checksums for: $filename"
          done

          if [ -f sha256.txt ]; then
            echo "=== sha256.txt ==="
            cat sha256.txt
            echo "=== sha512.txt ==="
            cat sha512.txt
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: app/release/

  release:
    name: Create GitHub Release
    needs: [check-releasable, build-macos]
    if: needs.check-releasable.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - name: Generate changelog
        env:
          NEXT_VERSION: ${{ needs.check-releasable.outputs.next_version }}
        run: |
          # Generate changelog for the upcoming version
          git-cliff --strip all --unreleased --tag $NEXT_VERSION > /tmp/release-notes.txt
          # Remove the version header line
          sed -i '1d' /tmp/release-notes.txt
          cat /tmp/release-notes.txt

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files

          # Copy distributable packages
          find all-artifacts -type f \( \
            -name "*.dmg" -o \
            -name "*.zip" \
          \) -exec cp {} release-files/ \;

          # Consolidate checksums from all platforms
          rm -f release-files/sha256.txt release-files/sha512.txt

          # Merge all sha256.txt files
          find all-artifacts -name "sha256.txt" -exec cat {} \; > release-files/sha256.txt

          # Merge all sha512.txt files
          find all-artifacts -name "sha512.txt" -exec cat {} \; > release-files/sha512.txt

          echo "=== Release files ==="
          ls -lah release-files/
          echo ""
          echo "=== Consolidated sha256.txt ==="
          cat release-files/sha256.txt
          echo ""
          echo "=== Consolidated sha512.txt ==="
          cat release-files/sha512.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-releasable.outputs.next_version }}
          name: ${{ needs.check-releasable.outputs.next_version }}
          body_path: /tmp/release-notes.txt
          files: release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
